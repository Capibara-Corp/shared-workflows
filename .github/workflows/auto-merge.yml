name: Auto Merge

on:
  workflow_call:
    inputs:
      timeout-minutes:
        description: 'Maximum time to wait for checks (in minutes)'
        required: false
        type: number
        default: 10
      poll-interval:
        description: 'Seconds between status checks'
        required: false
        type: number
        default: 30

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI checks to complete
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          TIMEOUT_MINUTES: ${{ inputs.timeout-minutes }}
          POLL_INTERVAL: ${{ inputs.poll-interval }}
        run: |
          echo "Waiting for CI checks on PR #$PR_NUMBER (SHA: $HEAD_SHA)..."

          TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
          ELAPSED=0

          # Initial wait for checks to be registered
          echo "Waiting 15s for checks to register..."
          sleep 15
          ELAPSED=15

          while [ $ELAPSED -lt $TIMEOUT_SECONDS ]; do
            echo "Checking status... (${ELAPSED}s elapsed)"

            # Get check runs directly from API using commit SHA
            CHECK_RUNS=$(gh api "repos/$REPO/commits/$HEAD_SHA/check-runs" --jq '.check_runs')

            # Filter out auto-merge workflow
            CI_RUNS=$(echo "$CHECK_RUNS" | jq '[.[] | select(.name | contains("auto-merge") | not)]')

            # Count by status
            TOTAL=$(echo "$CI_RUNS" | jq 'length')
            IN_PROGRESS=$(echo "$CI_RUNS" | jq '[.[] | select(.status == "in_progress" or .status == "queued")] | length')
            FAILED=$(echo "$CI_RUNS" | jq '[.[] | select(.conclusion == "failure" or .conclusion == "cancelled" or .conclusion == "timed_out")] | length')
            PASSED=$(echo "$CI_RUNS" | jq '[.[] | select(.conclusion == "success" or .conclusion == "skipped" or .conclusion == "neutral")] | length')

            echo "Status: $PASSED passed, $IN_PROGRESS in progress, $FAILED failed (total: $TOTAL)"

            # Debug: show check names
            echo "Checks found:"
            echo "$CI_RUNS" | jq -r '.[] | "  - \(.name): \(.status) / \(.conclusion)"'

            # If no CI checks exist yet, wait
            if [ "$TOTAL" -eq 0 ]; then
              echo "No CI checks found yet, waiting..."
              sleep $POLL_INTERVAL
              ELAPSED=$((ELAPSED + POLL_INTERVAL))
              continue
            fi

            # If any check failed, abort
            if [ "$FAILED" -gt 0 ]; then
              echo "Some checks failed. Aborting auto-merge."
              echo "$CI_RUNS" | jq -r '.[] | select(.conclusion == "failure" or .conclusion == "cancelled") | "  FAILED: \(.name)"'
              exit 1
            fi

            # If no in-progress checks, all done
            if [ "$IN_PROGRESS" -eq 0 ]; then
              echo "All CI checks passed!"
              break
            fi

            # Wait before next check
            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          if [ $ELAPSED -ge $TIMEOUT_SECONDS ]; then
            echo "Timeout reached. Some checks are still in progress."
            echo "$CI_RUNS" | jq -r '.[] | select(.status == "in_progress" or .status == "queued") | "  PENDING: \(.name)"'
            exit 1
          fi

      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Merging PR #$PR_NUMBER..."
          gh pr merge $PR_NUMBER --squash --delete-branch
          echo "PR merged successfully!"
