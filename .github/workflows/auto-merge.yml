name: Auto Merge

on:
  workflow_call:
    inputs:
      timeout-minutes:
        description: 'Maximum time to wait for checks (in minutes)'
        required: false
        type: number
        default: 15
      poll-interval:
        description: 'Seconds between status checks'
        required: false
        type: number
        default: 30

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI checks to complete
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TIMEOUT_MINUTES: ${{ inputs.timeout-minutes }}
          POLL_INTERVAL: ${{ inputs.poll-interval }}
        run: |
          echo "Waiting for CI checks on PR #$PR_NUMBER..."

          TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT_SECONDS ]; do
            echo "Checking status... (${ELAPSED}s elapsed)"

            # Get all check runs for this PR using correct fields
            CHECKS_JSON=$(gh pr checks $PR_NUMBER --json name,bucket,workflow 2>/dev/null || echo "[]")

            # Filter out auto-merge workflow itself
            CI_CHECKS=$(echo "$CHECKS_JSON" | jq '[.[] | select(.workflow != "Auto Merge")]')

            # Count checks by bucket
            TOTAL=$(echo "$CI_CHECKS" | jq 'length')
            PENDING=$(echo "$CI_CHECKS" | jq '[.[] | select(.bucket == "pending")] | length')
            FAILED=$(echo "$CI_CHECKS" | jq '[.[] | select(.bucket == "fail" or .bucket == "cancel")] | length')
            PASSED=$(echo "$CI_CHECKS" | jq '[.[] | select(.bucket == "pass" or .bucket == "skipping")] | length')

            echo "Status: $PASSED passed, $PENDING pending, $FAILED failed (total: $TOTAL)"

            # If no CI checks exist yet, wait
            if [ "$TOTAL" -eq 0 ]; then
              echo "No CI checks found yet, waiting..."
              sleep $POLL_INTERVAL
              ELAPSED=$((ELAPSED + POLL_INTERVAL))
              continue
            fi

            # If any check failed, abort
            if [ "$FAILED" -gt 0 ]; then
              echo "Some checks failed. Aborting auto-merge."
              echo "$CI_CHECKS" | jq -r '.[] | select(.bucket == "fail" or .bucket == "cancel") | "  - \(.name): \(.bucket)"'
              exit 1
            fi

            # If no pending checks, all done
            if [ "$PENDING" -eq 0 ]; then
              echo "All CI checks passed!"
              break
            fi

            # Wait before next check
            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          if [ $ELAPSED -ge $TIMEOUT_SECONDS ]; then
            echo "Timeout reached. Some checks are still pending."
            echo "$CI_CHECKS" | jq -r '.[] | select(.bucket == "pending") | "  - \(.name)"'
            exit 1
          fi

      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Merging PR #$PR_NUMBER..."
          gh pr merge $PR_NUMBER --squash --delete-branch
          echo "PR merged successfully!"
